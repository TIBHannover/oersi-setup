server {
  listen       80;
  server_name  localhost;
  location {{ oerindex_backend_searchapi_root_path }} {
    proxy_pass {{ oerindex_backend_internal_api_base_url }}/search/;
  }
  location {{ oerindex_backend_labelapi_root_path }} {
    proxy_pass {{ oerindex_backend_internal_api_base_url }}/label/;
  }
  location ~ "^{{ oerindex_public_base_path }}/((?:[A-Za-z0-9-_]{4}+){4,}(?:[A-Za-z0-9-_]{3}=|[A-Za-z0-9-_]{2}==)?)$" {
    # if-workaround, see https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/
    error_page 418 = @json_resource;
    error_page 419 = @html_resource;
    
    set $resourceId $1;
    set $requestedJson n;
    if ($http_accept ~ "application/json") {
      set $requestedJson "y";
    }
    if ($arg_format = "json") {
      set $requestedJson "y";
    }
    if ($requestedJson = "y") {
      return 418;
    }
    return 419;
  }
  location @json_resource {
    proxy_pass {{ oerindex_backend_internal_api_base_url }}/search/{{ elasticsearch_oer_index_alias_name }}/_doc/$resourceId/_source;
  }
  location @html_resource {
    proxy_pass http://127.0.0.1{{ oerindex_public_base_path }}/details/$resourceId;
  }
  location {{ oerindex_public_base_path }}/static {
    alias {{ oerindex_frontend_instdir }}/build/static;
    expires 1y;
    add_header Cache-Control "public, immutable";
  }
  location {{ oerindex_public_base_path }} {
    alias {{ oerindex_frontend_instdir }}/build;
    index  index.html;
    try_files $uri $uri/ /index.html =404;
    add_header Cache-Control "no-store, no-cache, must-revalidate";
  }
  location / {
    return 301 {{ oerindex_public_base_path }};
  }
  try_files $uri $uri/ /index.html;
  error_page   500 502 503 504  /50x.html;
  location = /50x.html {
    root   /usr/share/nginx/html;
  }
}
