input {
  jdbc {
    jdbc_connection_string => "jdbc:mariadb://{{ mariadb_host }}:{{ mariadb_port }}/{{ oerindex_db.name }}"
    jdbc_user => "{{ oerindex_db.user }}"
    jdbc_password => "{{ oerindex_db.password }}"
    jdbc_driver_library => "/usr/share/logstash/logstash-core/lib/jars/mariadb-connector-java.jar"
    jdbc_driver_class => "org.mariadb.jdbc.Driver"
    schedule => "{{ logstash_schedule }}"
    last_run_metadata_path => "{{ logstash_dir }}/.logstash_deletion_jdbc_last_run"
    parameters => { "record_status" => "DELETED"}
    statement => "SELECT m.identifier as id
                  FROM metadata m
                  WHERE date_modified_internal >:sql_last_value AND record_status_internal = :record_status"
  }
}
filter {
  clone {
    clones => ["internal"]
  }
  ruby {
    code => '
      event.set("[@metadata][doc_id]", Base64.urlsafe_encode64(event.get("id")))
      if event.get("type") === "internal"
        event.set("[@metadata][target_index]", "${OER_INDEX_INTERNAL_NAME}")
      else
        event.set("[@metadata][target_index]", "${OER_INDEX_NAME}")
      end
    '
  }
}
output {
    elasticsearch {
        hosts => ["http://localhost:9200"]
        index => "%{[@metadata][target_index]}"
        action => delete
        document_id => "%{[@metadata][doc_id]}"
        user => "{{ elasticsearch_oersi_logstash_username }}"
        password => "{{ elasticsearch_oersi_logstash_password }}"
    }
}
